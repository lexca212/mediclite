<style>
    body {
        background-color: white;
        margin-top: 50px;
        margin-bottom: 50px;
        font-size: 13px;
        font-family: Arial;
    }
    canvas{border:1px solid red; margin:0 auto; }
    #wrapper {
        width: 960px;
        margin: 0 auto;
    }
    table th, table td {
        background-color: white;
        line-height: 1.0;
    }
    .capture-mode #wrapper {
        padding: 60px !important;       /* kasih margin dalam */
        background: white !important;
        transform: scale(1.6);          /* PERBESAR KONTEN */
        transform-origin: top left;
        width: fit-content !important;  
    }
    @media print {
        select {
            appearance: none;
            -webkit-appearance: none;
            border: 0 !important;
            background: none !important;
            pointer-events: none;
        }
        canvas {
            border: none !important;
            box-shadow: none !important;
        }
        #saveButton ,#printPageButton {
            display: none !important;
        }
    }
    
</style>


<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="{?=url()?}/assets/jscripts/jquery.min.js"></script>
<script src="{?=url()?}/assets/jscripts/jspdf.min.js"></script>
<script src="{?=url()?}/assets/jscripts/jspdf.plugin.autotable.min.js"></script>
<script>
  function Cetak()
  {
      window.print();
  }

  function Simpan()
  {
    var url = "{?=url([ADMIN,'igd','simpanpersetujuanranap'])?}";
    var nomor_surat = $("#nomor_surat").val();
    var no_rawat = "{$pasien.0.no_rawat}";
    var no_rkm_medis = "{$pasien.0.no_rkm_medis}";
    var no_ktp = "{$pasien.0.no_ktp}";
    var nm_pasien = "{$pasien.0.nm_pasien}";
    var tgl_lahir = "{$pasien.0.tgl_lahir}";
    var umur = "{?=hitungUmur($pasien.0.tgl_lahir)?}";
    var jk = "{$pasien.0.jk}";
    var no_tlp = "{$pasien.0.no_tlp}";
    var alamat = "{$pasien.0.fullAlamat}";
    var tanggal = "{$tanggal}";
    var no_ktp_pj = $("#no_ktp_pj").val();
    var nm_pj = $("#nm_pj").text();
    var jk_pj = $("#jk_pj").val();
    var sts_hubungan = $("#sts_hubungan").val();
    sts_hubungan = sts_hubungan.toUpperCase();
    var no_tlp_pj = $("#no_tlp_pj").val();
    var alamat_pj = $("#alamat_pj").val();
    var nm_saksi =$("#nm_saksi").val();
    nm_saksi = nm_saksi.toLowerCase().replace(/\b\w/g, c => c.toUpperCase());
    var nm_petugas = $("#nm_petugas").val();
    nm_petugas = nm_petugas.toLowerCase().replace(/\b\w/g, c => c.toUpperCase());
    var kamar = $("#kamar").val();
    var kelas = $("#kelas").val();
    var hak_kls = $("#hak_kls").val();
    var status_kelas = $("#status_kelas").text()
    $.post(
      url, 
      {
        nomor_surat: nomor_surat, 
        no_rawat: no_rawat, 
        no_rkm_medis: no_rkm_medis, 
        no_ktp: no_ktp,
        nm_pasien: nm_pasien, 
        tgl_lahir: tgl_lahir, 
        umur: umur, 
        jk: jk, 
        no_tlp: no_tlp,
        alamat: alamat, 
        tanggal: tanggal,
        no_ktp_pj: no_ktp_pj, 
        nm_pj: nm_pj, 
        jk_pj: jk_pj, 
        sts_hubungan: sts_hubungan,
        no_tlp_pj: no_tlp_pj, 
        alamat_pj: alamat_pj,
        nm_saksi: nm_saksi, 
        nm_petugas: nm_petugas, 
        kamar: kamar, 
        kelas: kelas, 
        hak_kls: hak_kls, 
        status_kelas: status_kelas
      },
      function(data) {
        console.log(data);
        data = JSON.parse(data);
        console.log(data);
        if(data.status == 'success') {
          alert('Sukses');
        }
        if(data.status == 'error') {
          alert(data.msg);
        }
      }
    );
  }  
</script>
<div id="wrapper">
  <div style="width:960px;">
    <table class="mt-2 text-center">
      <thead>
        <tr>
          <th>
            <img src="{?=url()?}/{$settings.logo}" height="100px"
              style="margin-right: 20px;" alt>
          </th>
          <th colspan="2" width="100%">
            <p><span style="font-size: 28px;">{$settings.nama_instansi}</span><br>
              <span style="font-size: 18px;">Alamat: {$settings.alamat} - {$settings.kota} - {$settings.propinsi}</span><br>
              <span style="font-size: 18px;">Telepon: {$settings.nomor_telepon} - Email: {$settings.email}</span>
            </p>
          </th>
        </tr>
        <tr>
          <th colspan="3">
            <hr style="border-bottom: 2px solid #000;padding-top:3px;">
          </th>
        </tr>
      </thead>
    </table>
    <div class="text-center mb-4">
      <center>

        <h5 class="fw-bold">SURAT PERSETUJUAN PASIEN RAWAT
          INAP</h5>
        <p>
          Nomor:
          <input type="text"
            class="form-control d-inline-block printable-field"
            name="nomor_surat"
            id="nomor_surat"
            style="width:200px; border:0; padding:5px; margin-left:10px; background:#eee; display:inline-block;">
        <span class="printable-text d-none"></span>
        </p>
      </center>
    </div>
    <table id="tbl_persetujuan_umum">
      <thead>

      </thead>
      <tbody>
        <!-- Data Penanggung Jawab -->
        <p class="fw-bold" style="margin-bottom: 2px;">Yang bertanda tangan di bawah ini :</p>
        <table class="table table-borderless small-text w-100" style="margin-bottom: 2px;">
          <tr>
            <td class="col-3" style="width: 200px;">No. KTP</td>
            <td style="vertical-align: top;"> : </td>
            <td>
              <input type="text"
                  class="form-control d-inline-block printable-field"
                  name="no_ktp_pj" id="no_ktp_pj"
                  style="width:200px; height: 30px; border:0; background:#eee; display:inline-block;">
              <span class="printable-text d-none"></span>
            </td>
          </tr>
          <tr>
            <td class="col-3">Nama</td>
            <td style="vertical-align: top;"> : </td>
            <td>
              <input type="text"
                  class="form-control d-inline-block printable-field"
                  name="nm_pjawab" id="nm_pjawab" value="{$pasien.0.namakeluarga}"
                  style="width:200px; height: 30px; border:0; background:#eee; display:inline-block; text-transform: uppercase;">
              <span class="printable-text d-none" style="text-transform: uppercase;"></span>
            </td>
          </tr>
          <tr>
            <td class="col-3">Jenis Kelamin</td>
            <td style="vertical-align: top;"> : </td>
            <td>
              <select name="jk_pj" id="jk_pj" class="printable-field text-center"
                style="width:200px; border:0; padding:5px 0px; background:#eee;">
                <option value selected disabled>-- Pilih Jenis Kelamin --</option>
                <option value="Laki-laki">Laki-laki</option>
                <option value="Perempuan">Perempuan</option>
              </select> 
              <span class="printable-text d-none"></span>
            </td>
          </tr>

          <!-- <tr>
            <td class="col-3">Jenis Kelamin</td>
            <td style="vertical-align: top;"> : </td>
            <td>
              <input class="printable-field" type="radio" id="jk_pj" name="jk_pj" value="Laki-laki">
              <label for="jk_pj">Laki-laki</label>
              <input class="printable-field" type="radio" id="jk_pj" name="jk_pj" value="Perempuan">
              <label for="jk_pj">Perempuan</label>
              <input type="text"
                  class="form-control d-inline-block printable-field"
                  name="nomor_surat" id="nomor_surat" 
                  style="width:200px; height: 30px; border:0; background:#eee; display:inline-block;">
              <span class="printable-text d-none"></span>
            </td>
          </tr> -->
          <tr>
            <td class="col-3">Hubungan Keluarga</td>
            <td style="vertical-align: top;"> : </td>
            <td>
              <input type="text"
              class="form-control d-inline-block printable-field"
              name="sts_hubungan" id="sts_hubungan" value="{$pasien.0.keluarga}"
              style="width:200px; height: 30px; border:0; background:#eee; display:inline-block; text-transform: uppercase;">
              <span class="printable-text d-none" style="text-transform: uppercase;"></span>
            </td>
          </tr>
          <tr>
            <td class="col-3">No. Telp/HP</td>
            <td style="vertical-align: top;"> : </td>
            <td>
              <input type="text"
              class="form-control d-inline-block printable-field"
              name="no_tlp_pj" id="no_tlp_pj"
              style="width:200px; height: 30px; border:0; background:#eee; display:inline-block;">
              <span class="printable-text d-none"></span>
              
            </td>
          </tr>
          <tr>
            <td class="col-3">Alamat</td>
            <td style="vertical-align: top;"> : </td>
            <td>
              <textarea class="printable-field" name="alamat_pj" id="alamat_pj" cols="80" style="border:0px solid #fff;background-color: #eee;" oninput="auto_grow(this)">{$pasien.0.almt_pj}</textarea>
              <span class="printable-text d-none"></span>
            </td>
          </tr>
        </table>

        <p class="fw-bold" style="margin-bottom: 2px;">Membuat Persetujuan Terhadap Keluarga Kami,
          Pasien
          a/n :</p>

        <!-- Data Pasien -->
        <table class="table table-borderless small-text w-100" style="margin-bottom: 2px;">
          
          <tr>
            <td class="col-3" id="no_ktp" style="width: 200px;">No. KTP</td>
            <td>:
              {$pasien.0.no_ktp}
            </td>
          </tr>
          <tr>
            <td class="col-3" id="no_rawat" style="width: 200px;">No. Rawat</td>
            <td>:
              {$pasien.0.no_rawat}
            </td>
          </tr>
          <tr>
            <td class="col-3">Nama</td>
            <td>:
              {$pasien.0.nm_pasien} <span><b>({$pasien.0.no_rkm_medis})</b></span>
            </td>
          </tr>
          <tr>
            <td class="col-3">Jenis Kelamin</td>
            <td>:
              {$pasien.0.jk_text}
            </td>
          </tr>
          <tr>
            <td class="col-3">Tempat, Tgl Lahir</td>
            <td>:
              {$pasien.0.tmp_lahir}, {$pasien.0.tgl_lahir}
            </td>
          </tr>
          <tr>
            <td class="col-3">No. Telp/HP</td>
            <td>: 
              {$pasien.0.no_tlp}
            </td>
          </tr>
          <tr>
            <td class="col-3">Alamat</td>
            <td>:
              {$pasien.0.fullAlamat}
            </td>
          </tr>
        </table>

        <!-- Pernyataan -->
        <p class="small-text" style="margin-bottom: 2px;">
          Dengan ini menyatakan dengan sesungguhnya bahwa saya setuju untuk
          dilakukan Rawat Inap di RS Umum Fitri Candra dengan pembayaranBPJS
          NPBI di :
        </p>

        <table class="table table-borderless small-text w-100" style="margin-bottom: 2px;">
          <tr><td class="col-3">a. Ruang</td>
            <td>:
              <select name="kamar" id="kamar" class="printable-field text-center" 
                style="width:200px; border:0; padding:5px 0px; background:#eee;">
                <option value selected disabled>-- Pilih Ruang Rawat --</option>
                <?php foreach($kamar as $k) : ?>
                  <option value="<?= $k['kd_kamar'] ?>"><?= $k['kd_kamar'] ?></option>
                <?php endforeach; ?>
              </select> 
              <span class="printable-text d-none"></span>
            </td>
          </tr>
          <tr><td class="col-3">b. Kelas</td>
            <td>:
              <select name="kelas" id="kelas" class="printable-field text-center"
                style="width:200px; border:0; padding:5px 0px; background:#eee;">
                <option value selected disabled>-- Pilih Kelas Rawat --</option>
                <option value="Kelas 1">Kelas 1</option>
                <option value="Kelas 2">Kelas 2</option>
                <option value="Kelas 3">Kelas 3</option>
              </select> 
              <span class="printable-text d-none"></span>
            </td>
          </tr>
          <tr><td class="col-3">c. Hak Kelas Perawatan</td>
            <td>:
              <select name="hak_kls" id="hak_kls" class="printable-field text-center"
                style="width:200px; border:0; padding:5px 0px; background:#eee;">
                <option value selected disabled>-- Pilih Hak Kelas --</option>
                <option value="Kelas 1">Kelas 1</option>
                <option value="Kelas 2">Kelas 2</option>
                <option value="Kelas 3">Kelas 3</option>
              </select> 
              <span class="printable-text d-none"></span>
              <span id="status_kelas" class="ms-2 fw-bold"></span>
            </td>
          </tr>
        </table>

        <!-- Pernyataan tambahan -->
        <p class="fw-bold small-text" style="margin-bottom: 2px;">Demi kelancaran pelayanan perawatan,
          pengobatan dan administrasi, dengan ini juga menyatakan :</p>
        <ol class="small-text">
          <li>Pembiayaan yang sudah disetujui (Umum / Pribadi) Tidak bisa
            pindah ke Pembiayaan BPJS</li>
          <li>BPJS naik kelas dikenakan tambahan iur biaya</li>
          <li>Saya tidak menggunakan Asuransi BPJS yang saya miliki
            karena:<br>
            a. Keinginan saya sendiri<br>
            b. Tidak bisa memenuhi persyaratan<br>
          </li>
          <li>Kelengkapan berkas BPJS maksimal 3x24 jam hari kerja, bila
            dalam waktu yang ditentukan tidak bisa menunjukan kelengkapan
            persyaratan maka pembiayaan tidak ditanggung oleh BPJS.</li>
          <li>Peserta BPJS dengan hak rawat kelas 3, tidak bisa naik
            kelas.</li>
          <li>Terkait kamar kelas perawatan yang sedang kondisi penuh
            peserta BPJS akan ditempatkan di kelas perawatan sementara
            maksimal 3 hari.</li>

        </ol>

        <!-- Tanda Tangan -->
        <div class="row text-center signature-box small-text">
          <div class="col-4">
            <p style="margin-bottom: 37px;"></p>
            <p >Petugas</p>
            <tr>
              <td colspan="2">
                <canvas id="canvas1" class="printable-canvas" width="210" height="130"></canvas>
                <img class="canvas-image d-none">
              </td>
            </tr>
            <p  style="text-transform: capitalize;">
              <input
                type="text" class="form-control text-center fw-bold printable-field" name="nm_petugas" id="nm_petugas" value="{$petugas}"
                style="width: 220px;border: 0;padding:5px;margin: 2px 0 0 43px;background-color:#eee; text-transform: capitalize;">
              <span style="text-transform: capitalize;" class="printable-text d-none fw-bold"></span>
            </p>
          </div>
          <div class="col-4">
            <p style="margin-bottom: 37px;"></p>
            <p >Saksi</p>
            <tr>
              <td colspan="2">
                <canvas id="canvas2" class="printable-canvas" width="210" height="130"></canvas>
                <img class="canvas-image d-none">
              </td>
            </tr>
            <p  style="text-transform: capitalize;">
              <input
                type="text" class="form-control text-center fw-bold printable-field" name="nm_saksi" id="nm_saksi"
                style="width: 220px;border: 0;padding:5px;margin: 2px 0 0 43px;background-color:#eee; text-transform: capitalize;">
              <span style="text-transform: capitalize;" class="printable-text d-none fw-bold"></span>
            </p>
          </div>
          <div class="col-4">
            <p>Wonogiri, {$tanggal}</p>
            <p >Yang Menyatakan</p>
            <tr>
              <td colspan="2">
                <canvas id="canvas3" class="printable-canvas" width="210" height="130"></canvas>
                <img class="canvas-image d-none">
              </td>
            </tr>
            <p class="fw-bold" id="nm_pj"
              style="text-transform: capitalize;"></p>
          </div>
        </div>
      </table>
    </div>

    <button class="printable-field" id="saveButton" onclick="Simpan()">&#9635; Simpan</button> <button class="printable-field" id="printPageButton" onclick="Cetak()">&#128424; Cetak</button>

    <script>
      // Fungsi untuk mengubah jadi Capitalize (huruf pertama tiap kata besar)
      function capitalizeWords(str) {
        return str.toLowerCase().replace(/\b\w/g, c => c.toUpperCase());
      }

      // Jalankan saat halaman dimuat
      $(document).ready(function() {
        // Set awal dari value input ke <p>
        let initial = $("#nm_pjawab").val();
        $("#nm_pj").text(capitalizeWords(initial));

        // Update otomatis setiap kali user mengetik atau mengubah input
        $("#nm_pjawab").on("input", function() {
          let val = $(this).val();
          $("#nm_pj").text(capitalizeWords(val));
        });
      });
    </script>

    <script>
      var level = {
        "Kelas 1": 1,
        "Kelas 2": 2,
        "Kelas 3": 3
      };

      
      $("#hak_kls").on("change", function () {
          var kelas_pasien = $("#kelas").val();
          var level_pasien = level[kelas_pasien];
          
          var kelas_dipilih = $(this).val();
          var level_dipilih = level[kelas_dipilih];

          if (level_pasien === level_dipilih) {
              $("#status_kelas").text("Sesuai Hak").css("color", "green");

          } else if (level_pasien > level_dipilih
            
          ) {
              $("#status_kelas").text("Invalid").css("color", "red");

          } else {
              $("#status_kelas").text("Naik Kelas").css("color", "green");
          }
      });
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", () => {

        const canvasIds = ["canvas1", "canvas2", "canvas3"];
        const canvases = {};
        const ctx = {};
        const state = {};

        canvasIds.forEach(id => {
          const canvas = document.getElementById(id);
          canvases[id] = canvas;
          ctx[id] = canvas.getContext("2d");

          state[id] = {
            flag: false,
            dotFlag: false,
            prevX: 0, prevY: 0,
            currX: 0, currY: 0
          };

          // ðŸ–±ï¸ Mouse events
          canvas.addEventListener("mousedown", e => handleDraw(id, "down", e));
          canvas.addEventListener("mousemove", e => handleDraw(id, "move", e));
          canvas.addEventListener("mouseup", e => handleDraw(id, "up", e));
          canvas.addEventListener("mouseout", e => handleDraw(id, "out", e));

          // ðŸ¤š Touch events
          canvas.addEventListener("touchstart", e => {
            handleDraw(id, "down", e.touches[0]);
            e.preventDefault();
          });
          canvas.addEventListener("touchmove", e => {
            handleDraw(id, "move", e.touches[0]);
            e.preventDefault();
          });
          canvas.addEventListener("touchend", e => handleDraw(id, "up", e.changedTouches[0]));
          canvas.addEventListener("touchcancel", e => handleDraw(id, "out", e.changedTouches[0]));
        });

        function handleDraw(id, action, e) {
          const c = state[id];
          const rect = canvases[id].getBoundingClientRect();

          if (action === "down") {
            c.prevX = c.currX;
            c.prevY = c.currY;
            c.currX = e.clientX - rect.left;
            c.currY = e.clientY - rect.top;
            c.flag = true;
            c.dotFlag = true;

            if (c.dotFlag) {
              ctx[id].beginPath();
              ctx[id].fillStyle = "black";
              ctx[id].fillRect(c.currX, c.currY, 2, 2);
              ctx[id].closePath();
              c.dotFlag = false;
            }
          }

          if (action === "up" || action === "out") {
            c.flag = false;
          }

          if (action === "move" && c.flag) {
            c.prevX = c.currX;
            c.prevY = c.currY;
            c.currX = e.clientX - rect.left;
            c.currY = e.clientY - rect.top;
            drawLine(id, c.prevX, c.prevY, c.currX, c.currY);
          }
        }

        function drawLine(id, x1, y1, x2, y2) {
          const context = ctx[id];
          context.beginPath();
          context.moveTo(x1, y1);
          context.lineTo(x2, y2);
          context.strokeStyle = "black";
          context.lineWidth = 2;
          context.stroke();
          context.closePath();
        }
      });
    </script>
    <script>
        document.getElementById('saveButton').addEventListener('click', function () {

          document.body.classList.add("capture-mode");

          document.querySelectorAll(".printable-field").forEach(el => {
              let span = el.nextElementSibling;
              if (span && span.classList.contains("printable-text")) {
                  span.textContent =
                      el.value ||
                      el.options?.[el.selectedIndex]?.text || "";
                  span.classList.remove("d-none");
              }
              el.classList.add("d-none");
          });

          document.querySelectorAll(".printable-canvas").forEach(c => {
              const imgEl = c.nextElementSibling;
              if (imgEl && imgEl.classList.contains("canvas-image")) {
                  imgEl.src = c.toDataURL("image/png");
                  imgEl.classList.remove("d-none");
              }
              c.classList.add("d-none");
          });

          setTimeout(() => {

              html2canvas(document.querySelector("#wrapper"), {
                  scale: 2,
                  useCORS: true,
                  backgroundColor: "#ffffff",
                  scrollX: 0,
                  scrollY: 0
              }).then(canvas => {

                  const imgData = canvas.toDataURL("image/png");
                  const no_rawat = '<?= $pasien.0.no_rawat ?>';
                  console.log(no_rawat);

                  const formData = new FormData();
                  formData.append('imgData', imgData);
                  formData.append('no_rawat',no_rawat);

                  $.ajax({
                      url: '{?=url()?}/igd/simpanpersetujuanranap',
                      type: 'POST',
                      data: formData,
                      contentType: false,
                      processData: false,
                      success: function (data) {
                          alert('âœ… Gambar disimpan!');
                          console.log(data);
                      }
                  });

                  document.body.classList.remove("capture-mode");

                  document.querySelectorAll(".printable-field").forEach(el => {
                      let span = el.nextElementSibling;
                      if (span) span.classList.add("d-none");
                      el.classList.remove("d-none");
                  });

                  document.querySelectorAll(".canvas-image").forEach(i => i.classList.add("d-none"));
                  document.querySelectorAll(".printable-canvas").forEach(c => c.classList.remove("d-none"));

              });

          }, 120); // âœ… Delay 120 ms â†’ hasil paling stabil (boleh antara 80â€“150)
      });
    </script>


  </body>
</html>